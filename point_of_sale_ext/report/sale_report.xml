<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>
<!--        <report-->
<!--                id="pos_ord_session_reprt"-->
<!--                string="Pos Order Report"-->
<!--                model="pos.session"-->
<!--                report_type="qweb-pdf"-->
<!--                file="point_of_sale_ext.pos_order_template"-->
<!--                name="point_of_sale_ext.pos_order_template"-->
<!--                paperformat_id="paperformat_pos_summary_report"/>-->

         <record id="paperformat_pos_summary_report" model="report.paperformat">
            <field name="name">A4</field>
            <field name="default" eval="True" />
            <field name="format">A4</field>
            <field name="page_height">0</field>
            <field name="page_width">0</field>
            <field name="orientation">Portrait</field>
            <field name="margin_top">40</field>
            <field name="margin_bottom">32</field>
            <field name="margin_left">7</field>
            <field name="margin_right">7</field>
            <field name="header_line" eval="False" />
            <field name="header_spacing">35</field>
            <field name="dpi">90</field>
        </record>


         <record id="pos_ord_session_reprt" model="ir.actions.report">
        <field name="name">Pos Order Report</field>
        <field name="model">pos.session</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">point_of_sale_ext.pos_order_template</field>
        <field name="report_file">point_of_sale_ext.pos_order_template</field>
        <field name="print_report_name">'Pos Order Report'</field>
        <field name="binding_model_id" ref="model_pos_session"/>
        <field name="binding_type">report</field>
        <field name="paperformat_id" ref="paperformat_pos_summary_report"/>
    </record>

        <template id="pos_order_template">
            <t t-call="web.html_container">
                <t t-call="web.external_layout">
                    <div class="page">
                        <h2 align="center">POS Summary Report</h2>
                        <br/>
                        <div class="row">
                            <div class="col-3">
                                <span>Date:</span>
                                <span t-esc="time.strftime('%Y-%m-%d')"/>
                            </div>
                            <div class="col-3">
                                <span>Time:</span>
                                <span t-esc="time.strftime('%H:%M:%S')"/>
                            </div>
                        </div>
                        <div>
                            <span>Location:</span>
                            <span t-esc="location"/>
                        </div>
                        <div class="text-center">
                            <strong>
                                <center>Order Lines</center>
                            </strong>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th class="text-center">
                                            <span>Product</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Quantity</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Tax</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Labour Surcharge</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount Without Tax</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-set="orderline_total_qty" t-value="0" />
                                    <t t-set="orderline_total_sub_inc" t-value="0" />
<!--                                    <t t-set="orderline_total_tax" t-value="0" />-->
                                    <t t-set="orderline_total_sub" t-value="0" />
                                    <t t-set="labor_surcharge_total" t-value="0" />
                                    <t t-foreach="env['pos.order.line'].get_order_line(orderlines)" t-as="order">
                                        <tr>
                                            <t t-set="orderline_total_qty" t-value="orderline_total_qty + order.get('qty', False)" />
                                            <t t-set="orderline_total_sub_inc" t-value="orderline_total_sub_inc + round(order.get('price_subtotal_incl', False), 2)" />
                                            <t t-set="orderline_total_sub" t-value="orderline_total_sub + round(order.get('price_subtotal', False), 2)" />
                                            <t t-set="labor_surcharge" t-value="0"/>
                                            <t t-set="orderline_labor_surcharge" t-value="order.get('tax_ids_after_fiscal_position', []).filtered(lambda x: x.name == 'Labor Surcharge')" />
                                            <t t-if="orderline_labor_surcharge">
                                                <t t-set="labor_surcharge" t-value="round((order.get('price_subtotal', False) * orderline_labor_surcharge.amount) / 100,2)"/>
                                            </t>
                                            <td>
                                                <span t-esc="order.get('full_product_name', False)"/>
                                            </td>
                                            <td>
                                                <span t-esc="round(order.get('qty', False), 1)"/>
                                            </td>
                                            <td>
                                                <span t-esc="round(order.get('price_subtotal_incl', False), 2)"/>
                                            </td>
                                            <td>
                                                <span t-esc="round(round(order.get('price_subtotal_incl', False) - order.get('price_subtotal', False), 2) - labor_surcharge,2)"/>
                                            </td>
                                            <td>
                                                <span t-esc="labor_surcharge"/>
                                                <t t-set="labor_surcharge_total" t-value="labor_surcharge_total + labor_surcharge"/>
                                            </td>
                                            <td>
                                                <span t-esc="round(order.get('price_subtotal', False), 2)"/>
                                            </td>
                                        </tr>
                                    </t>
<!--                                    border-top: 1px double black;-->
                                    <tr style="border-top: 5px double black;">
                                        <td>
                                            <b>Gross Sales</b>
                                        </td>
                                        <td>
                                            <b t-esc="orderline_total_qty"/>
                                        </td>
                                        <td>
                                            <b t-esc="round(orderline_total_sub_inc, 2)"/>
                                        </td>
                                        <td>
                                            <b t-esc="round(orderline_total_sub_inc - orderline_total_sub, 2) - round(labor_surcharge_total, 2)"/>
                                        </td>
                                        <td>
                                            <b t-esc="round(labor_surcharge_total, 2)"/>
                                        </td>
                                        <td>
                                            <b t-esc="round(orderline_total_sub, 2)"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <br/>
                        <div class="text-center">
                            <strong>
                                <center>Promotions</center>
                            </strong>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th class="text-center">
                                            <span>Name of Promotions</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Quantity</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Tax</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount Without Tax</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-set="promotion_total_qty" t-value="0" />
                                    <t t-set="promotion_total_sub_inc" t-value="0" />
                                    <t t-set="promotion_total_sub" t-value="0" />
                                    <t t-foreach="env['pos.order.line'].get_order_line(promotion_lines)" t-as="promo">
                                        <tr>
                                            <t t-set="promotion_total_qty" t-value="promotion_total_qty + promo.get('qty', False)" />
                                            <t t-set="promotion_total_sub_inc" t-value="promotion_total_sub_inc + round(promo.get('price_subtotal_incl', False), 2)" />
<!--                                            <t t-set="orderline_total_tax" t-value="orderline_total_tax + order.get('price_subtotal_incl', False) - order.get('price_subtotal', False)" />-->
                                            <t t-set="promotion_total_sub" t-value="promotion_total_sub + round(promo.get('price_subtotal', False), 2)" />
                                            <td>
                                                <span t-esc="promo.get('full_product_name', False)"/>
                                            </td>
                                            <td>
                                                <span t-esc="round(promo.get('qty', False), 1)"/>
                                            </td>
                                            <td>
                                                <span t-esc="round(promo.get('price_subtotal_incl', False), 2)"/>
                                            </td>
                                            <td>
                                                <span t-esc="round(promo.get('price_subtotal_incl', False) - promo.get('price_subtotal', False), 2)"/>
                                            </td>
                                            <td>
                                                <span t-esc="round(promo.get('price_subtotal', False), 2)"/>
                                            </td>
                                        </tr>
                                    </t>
<!--                                    border-top: 1px double black;-->
                                    <tr style="border-top: 5px double black;">
                                        <td>
                                            <b>Total Discounts</b>
                                        </td>
                                        <td>
                                            <b t-esc="round(promotion_total_qty, 1)"/>
                                        </td>
                                        <td>
                                            <b t-esc="round(promotion_total_sub_inc, 2)"/>
                                        </td>
                                        <td>
                                            <b t-esc="round(promotion_total_sub_inc - promotion_total_sub, 2)"/>
                                        </td>
                                        <td>
                                            <b t-esc="round(promotion_total_sub, 2)"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <br />
                        <div class="text-center">
                            <strong>
                                <center>Sales made by staff</center>
                            </strong>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th class="text-center">
                                            <span>Therapist</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Tips</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Tax</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Labor Surcharge</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount Without Tax</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
<!--                                    env['pos.order'].read_group([('id', 'in', self.order_ids.ids)], fields=['amount_tax', 'amount_total', 'tip_amount'], groupby=['employee_id'])-->
<!--                                    env['pos.order.line'].read_group([('id', 'in', env['pos.order.line'].browse(orderlines).ids)], fields=['price_subtotal_incl', 'tax_ids_after_fiscal_position', 'price_subtotal'], groupby=['employee_id'])-->
                                    <t t-set="line_total_tip" t-value="0" />
                                    <t t-set="line_total_amount" t-value="0" />
                                    <t t-set="line_total_tax" t-value="0" />
                                    <t t-set="line_total_tax_without" t-value="0" />
                                    <t t-set="line_total_labor_surcharge" t-value="0" />
                                    <t t-set="sales_staff" t-value="env['pos.session'].get_sale_by_cashier(order_ids)" />
<!--                                    read_group([('pos_id', 'in', order_ids)], fields=['amount_tax', 'amount_total', 'tip_amount'], groupby=['employee_id'])-->
                                    <t t-foreach="sales_staff" t-as="staff">
                                        <t t-set="line_total_tip" t-value="line_total_tip + round(sales_staff[staff].get('tip_amount', 0), 2)" />
                                        <t t-set="line_total_amount" t-value="line_total_amount + round(sales_staff[staff].get('amount', 0), 2)" />
                                        <t t-set="line_total_tax" t-value="line_total_tax + round(sales_staff[staff].get('amount_tax', 0), 2)" />
                                        <t t-set="line_total_tax_without" t-value="line_total_tax_without + round(sales_staff[staff].get('amount_without', 0), 2)" />
                                        <t t-set="line_total_labor_surcharge" t-value="line_total_labor_surcharge + round(sales_staff[staff].get('labor_surcharge', False), 2)" />
                                        <tr>
                                            <td>
                                                <span t-if="sales_staff[staff].get('employee', False)" t-esc="sales_staff[staff].get('employee').name" />
                                            </td>
                                            <td>
                                                <span t-if="sales_staff[staff].get('tip_amount', False)" t-esc="round(sales_staff[staff].get('tip_amount'), 2)" />
                                                <span t-else="" t-esc="float(0)" />
                                            </td>
                                            <td>
                                                <span t-if="sales_staff[staff].get('amount', False)" t-esc="round(sales_staff[staff].get('amount', False), 2)" />
                                                <span t-else="" t-esc="float(0)" />
                                            </td>
                                            <td>
                                                <span t-if="sales_staff[staff].get('amount_tax', False)" t-esc="round(sales_staff[staff].get('amount_tax', False), 2) - round(sales_staff[staff].get('labor_surcharge', False), 2)" />
                                                <span t-else="" t-esc="float(0)" />
                                            </td>
                                            <td>
                                                <span t-if="sales_staff[staff].get('labor_surcharge', False)" t-esc="round(sales_staff[staff].get('labor_surcharge', False), 2)" />
                                                <span t-else="" t-esc="float(0)" />
                                            </td>
                                            <td>
                                                <span t-if="sales_staff[staff].get('amount_without', False)" t-esc="round(sales_staff[staff].get('amount_without', False), 2)" />
                                                <span t-else="" t-esc="float(0)" />
                                            </td>
                                        </tr>
                                    </t>
                                    <tr style="border-top: 5px double black;">
                                        <td>
                                            <b>Total Sales made by staff</b>
                                        </td>
                                        <td>
                                            <b t-esc="round(line_total_tip, 2)"/>
                                        </td>
                                        <td>
                                            <b t-esc="round(line_total_amount, 2)"/>
                                        </td>
                                        <td>
                                            <b t-esc="round(line_total_tax, 2) - round(line_total_labor_surcharge, 2)"/>
                                        </td>
                                        <td>
                                            <b t-esc="round(line_total_labor_surcharge, 2)"/>
                                        </td>
                                        <td>
                                            <b t-esc="round(line_total_tax_without,2)"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <br/>
                        <div class="text-center">
                            <strong>
                                <center>Payment Modes</center>
                            </strong>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th class="text-center">
                                            <span>Name</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Tips</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Qty</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount Without tips</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Total Amount Paid</span>
                                        </th>
<!--                                        <th class="text-center">-->
<!--                                            <span>Amount Without Tax</span>-->
<!--                                        </th>-->
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-set="payment_tip_total" t-value="0" />
                                    <t t-set="payment_total_quantity" t-value="0"/>
                                    <t t-set="payment_amount_total" t-value="0" />
                                    <t t-foreach="env['pos.payment'].read_group([('session_id', '=', rec_id)], fields=['amount'], groupby=['payment_method_id'])"
                                        t-as="method">
                                        <t t-set="payment_total_quantity" t-value="payment_total_quantity + method.get('payment_method_id_count',0)" />
                                        <t t-set="payment_amount_total" t-value="payment_amount_total + method.get('amount', 0)" />
                                        <tr>
                                            <td>
                                                <span t-if="method['payment_method_id'] and method['payment_method_id'][0]" t-esc="env['pos.payment'].search([('payment_method_id', '=', method['payment_method_id'][0]), ('session_id', '=', rec_id)]).payment_method_id.name"/>
                                            </td>
                                            <td>
                                                <t t-if="method['payment_method_id'] and method['payment_method_id'][0]">
                                                    <t t-set="tip_amount" t-value="round(sum(env['pos.payment'].search([('payment_method_id', '=', method['payment_method_id'][0]), ('session_id', '=', rec_id), ('is_tip','=',True)]).mapped('amount')), 2)"/>
                                                    <span t-esc="tip_amount"/>
                                                    <t t-set="payment_tip_total" t-value="payment_tip_total + tip_amount" />
                                                </t>
                                            </td>
                                            <td>
                                                <span t-esc="float(method.get('payment_method_id_count', 0))" />
                                            </td>
                                            <td>
                                                <span t-if="method.get('amount', False)" t-esc="round(method.get('amount'), 2) - tip_amount" />
                                                <span t-else="" t-esc="float(0)" />
                                            </td>
                                            <td>
                                                <span t-if="method.get('amount', False)" t-esc="round(method.get('amount'), 2)" />
                                                <span t-else="" t-esc="float(0)" />
                                            </td>
                                        </tr>
                                    </t>
                                    <tr>
                                        <td>
                                            <b>Total Payment</b>
                                        </td>
                                        <td>
                                            <b t-esc="payment_tip_total"/>
                                        </td>
                                        <td>
                                            <b t-esc="float(payment_total_quantity)"/>
                                        </td>
                                        <td>
                                            <b t-esc="round((payment_amount_total - payment_tip_total), 2)"/>
                                        </td>
                                        <td>
                                            <b t-esc="round(payment_amount_total, 2)"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <br />
                        <div class="text-center">
                            <strong>
                                <center>Payment By Currency</center>
                            </strong>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th class="text-center">
                                            <span>Name</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Quantity</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                       <t t-foreach="env['pos.session'].get_payment_data(rec_id)"
                                       t-as="currency_payment">
                                        <tr>
                                            <td>
                                                <span t-esc="currency_payment['currency']"/>
                                            </td>
                                            <td>
                                                <span t-esc="round(currency_payment['account_currency'], 2)"/>
                                            </td>
                                            <td>
                                                <span t-esc="round(currency_payment.get('amount', False), 2)"/>
                                            </td>
                                        </tr>

                                    </t>
                                </tbody>
                            </table>
                        </div>
                        <br/>
                        <div>
                            <Strong align="center">Gross Sales:</Strong>
                            <span t-options="{'widget': 'monetary', 'from_currency': env['pos.order.line'].get_currency(), 'display_currency': env['pos.order.line'].get_currency()}" t-esc="round(orderline_total_sub_inc, 2)"/>
                            <br/>
                            <Strong align="center">Discount Amount:</Strong>
                            <span t-options="{'widget': 'monetary', 'from_currency': env['pos.order.line'].get_currency(), 'display_currency': env['pos.order.line'].get_currency()}" t-esc="round(discount_amount, 2)"/>
                            <br/>
<!--                             in <t t-esc="env['pos.order.line'].get_currency().name"/> without Tax-->
                            <Strong align="center">Total:</Strong>
                            <span t-options="{'widget': 'monetary', 'from_currency': env['pos.order.line'].get_currency(), 'display_currency': env['pos.order.line'].get_currency()}" t-esc="round(total_with_tax_aed, 2)"/>
                            <br/>
                            <Strong align="center">Tax:</Strong>
                            <span t-options="{'widget': 'monetary', 'from_currency': env['pos.order.line'].get_currency(), 'display_currency': env['pos.order.line'].get_currency()}" t-esc="round(total_tax, 2)"/>
                            <br/>
                            <Strong align="center">Net Sales:</Strong>
                            <span t-options="{'widget': 'monetary', 'from_currency': env['pos.order.line'].get_currency(), 'display_currency': env['pos.order.line'].get_currency()}" t-esc="round(total_without_tax_aed, 2)"/>
                            <br/>
                            <Strong align="center">Number Of Transactions:</Strong>
                            <span t-esc="env['pos.order'].search_count([('session_id', '=', rec_id)])"/>
<!--                            <br/>-->
<!--                            <Strong align="center">Discount Amount:</Strong>-->
<!--                            <span t-esc="env['pos.session'].browse(rec_id).get_discount()"/>-->
                        </div>
                        <div t-if="is_us and env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'product')" class="text-center">
                            <strong>
                                <center>Product without tax &amp; product tax</center>
                            </strong>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th class="text-center">
                                            <span>Quantity</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Tax</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount Without Tax</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <span t-esc="sum(env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'product').mapped('qty'))"/>
                                        </td>
                                        <td>

                                            <span t-esc="round(sum(env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'product').mapped('price_subtotal_incl')))"/>
                                        </td>
                                        <td>
                                            <span t-esc="round(sum(env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'product').mapped('order_id').mapped('amount_tax')))"/>
                                        </td>
                                        <td>
                                            <span t-esc="round(sum(env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'product').mapped('price_subtotal')))"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div t-if="is_us and env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'product')" class="text-center">
                            <strong>
                                <center>Product without tax &amp; product tax</center>
                            </strong>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th class="text-center">
                                            <span>Quantity</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Tax</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount Without Tax</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <span t-esc="sum(env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'product').mapped('qty'))"/>
                                        </td>
                                        <td>

                                            <span t-esc="round(sum(env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'product').mapped('price_subtotal_incl')))"/>
                                        </td>
                                        <td>
                                            <span t-esc="round(sum(env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'product').mapped('order_id').mapped('amount_tax')))"/>
                                        </td>
                                        <td>
                                            <span t-esc="round(sum(env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'product').mapped('price_subtotal')))"/>
                                        </td>

                                    </tr>

                                </tbody>
                            </table>
                        </div>
                        <div t-if="is_us and env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'service')" class="text-center">
                            <strong>
                                <center>Services without tax &amp; service tax</center>
                            </strong>
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th class="text-center">
                                            <span>Quantity</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Tax</span>
                                        </th>
                                        <th class="text-center">
                                            <span>Amount Without Tax</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                        <tr>
                                            <td>
                                            <span t-esc="sum(env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'service').mapped('qty'))"/>
                                        </td>
                                        <td>

                                            <span t-esc="round(sum(env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'service').mapped('price_subtotal_incl')))"/>
                                        </td>
                                        <td>
                                            <span t-esc="round(sum(env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'service').mapped('order_id').mapped('amount_tax')))"/>
                                        </td>
                                        <td>
                                            <span t-esc="round(sum(env['pos.order.line'].browse(orderlines).filtered(lambda o: o.product_id.detailed_type == 'service').mapped('price_subtotal')))"/>
                                        </td>
                                        </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </t>
            </t>
        </template>


    </data>
</odoo>
